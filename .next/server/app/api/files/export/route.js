(()=>{var e={};e.id=344,e.ids=[344],e.modules={399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2007:e=>{"use strict";e.exports=require("pdf-lib")},8893:e=>{"use strict";e.exports=require("buffer")},4770:e=>{"use strict";e.exports=require("crypto")},7702:e=>{"use strict";e.exports=require("events")},2615:e=>{"use strict";e.exports=require("http")},5240:e=>{"use strict";e.exports=require("https")},8216:e=>{"use strict";e.exports=require("net")},8621:e=>{"use strict";e.exports=require("punycode")},6162:e=>{"use strict";e.exports=require("stream")},2452:e=>{"use strict";e.exports=require("tls")},7360:e=>{"use strict";e.exports=require("url")},1568:e=>{"use strict";e.exports=require("zlib")},3808:e=>{"use strict";e.exports=import("docx")},2052:()=>{},5600:()=>{},6143:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>u,requestAsyncStorage:()=>l,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>d});var a=r(8967),n=r(3589),o=r(8329),i=r(3250),c=e([i]);i=(c.then?(await c)():c)[0];let p=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/files/export/route",pathname:"/api/files/export",filename:"route",bundlePath:"app/api/files/export/route"},resolvedPagePath:"/Users/jeffnwagbo/AI Law Firm/constructa-starter-min-main/src/app/api/files/export/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:l,staticGenerationAsyncStorage:d,serverHooks:g}=p,f="/api/files/export/route";function u(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:d})}s()}catch(e){s(e)}})},3250:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{GET:()=>p,POST:()=>u});var a=r(8148),n=r(2133),o=r(7765),i=r(1717),c=e([o]);async function u(e){try{let{documentId:t,format:r,regenerate:s=!1}=await e.json();if(!t)return a.NextResponse.json({success:!1,error:"Document ID is required",code:"INVALID_INPUT"},{status:400});if(!["docx","pdf"].includes(r))return a.NextResponse.json({success:!1,error:"Invalid export format. Must be docx or pdf",code:"INVALID_FORMAT"},{status:400});let c=e.headers.get("authorization");if(!c?.startsWith("Bearer "))return a.NextResponse.json({success:!1,error:"Authentication required",code:"UNAUTHORIZED"},{status:401});let u=c.split(" ")[1],{data:{user:p},error:l}=await n.p.auth.getUser(u);if(l||!p)return a.NextResponse.json({success:!1,error:"Invalid authentication token",code:"UNAUTHORIZED"},{status:401});let{data:d,error:g}=await n.p.from("docs").select("*").eq("id",t).eq("user_id",p.id).single();if(g||!d)return a.NextResponse.json({success:!1,error:"Document not found",code:"NOT_FOUND"},{status:404});let f=`${t}.${r}`,x=null;if(!s&&("docx"===r?d.docx_url:d.pdf_url)){let{data:e,error:t}=await n.p.storage.from("documents").list("",{search:f});if(!t&&e?.length>0){let{data:e,error:t}=await n.p.storage.from("documents").createSignedUrl(f,3600);if(!t&&e?.signedUrl)return a.NextResponse.json({success:!0,data:{downloadUrl:e.signedUrl,filename:`${d.title.replace(/\s+/g,"_")}.${r}`,expiresAt:new Date(Date.now()+36e5).toISOString()}})}}try{let e;e="docx"===r?await (0,o.RI)({title:d.title,content:d.content,docType:d.doc_type,metadata:{author:p.email||"AI Law Agent User",created:new Date(d.created_at)}}):await (0,i.$w)({title:d.title,content:d.content,metadata:{author:p.email||"AI Law Agent User",creator:"AI Law Agent MVP"}});let{data:s,error:c}=await n.p.storage.from("documents").upload(f,e,{contentType:"docx"===r?"application/vnd.openxmlformats-officedocument.wordprocessingml.document":"application/pdf",upsert:!0});if(c)return console.error("Storage upload error:",c),a.NextResponse.json({success:!1,error:"Failed to upload file to storage",code:"UPLOAD_ERROR"},{status:500});let{data:u,error:l}=await n.p.storage.from("documents").createSignedUrl(f,3600);if(l||!u?.signedUrl)return console.error("Signed URL error:",l),a.NextResponse.json({success:!1,error:"Failed to generate download URL",code:"URL_ERROR"},{status:500});return x=u.signedUrl,await n.p.from("docs").update({["docx"===r?"docx_url":"pdf_url"]:x,updated_at:new Date().toISOString()}).eq("id",t),a.NextResponse.json({success:!0,data:{downloadUrl:x,filename:`${d.title.replace(/\s+/g,"_")}.${r}`,expiresAt:new Date(Date.now()+36e5).toISOString()}})}catch(e){return console.error("File generation error:",e),a.NextResponse.json({success:!1,error:`Failed to generate ${r.toUpperCase()} file`,code:"GENERATION_ERROR"},{status:500})}}catch(e){return console.error("Export API error:",e),a.NextResponse.json({success:!1,error:"Internal server error",code:"INTERNAL_ERROR"},{status:500})}}async function p(){return a.NextResponse.json({success:!1,error:"Method not allowed",code:"METHOD_NOT_ALLOWED"},{status:405})}o=(c.then?(await c)():c)[0],s()}catch(e){s(e)}})},7765:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.d(t,{RI:()=>o});var a=r(3808),n=e([a]);async function o(e){let{title:t,content:r,docType:s,metadata:n}=e,o=function(e){let t=[];for(let r of e.replace(/<\/p>/g,"</p>\n").replace(/<\/h[1-6]>/g,"</h>\n").split("\n").filter(e=>e.trim())){let e=r.replace(/<[^>]*>/g,"").trim();if(e){if(r.includes("<h1"))t.push(new a.Paragraph({text:e,heading:a.HeadingLevel.HEADING_1,spacing:{after:240}}));else if(r.includes("<h2"))t.push(new a.Paragraph({text:e,heading:a.HeadingLevel.HEADING_2,spacing:{after:200}}));else if(r.includes("<h3"))t.push(new a.Paragraph({text:e,heading:a.HeadingLevel.HEADING_3,spacing:{after:160}}));else{let s=[];r.includes("<strong>")||r.includes("<b>")?s.push(new a.TextRun({text:e,bold:!0})):r.includes("<em>")||r.includes("<i>")?s.push(new a.TextRun({text:e,italics:!0})):s.push(new a.TextRun({text:e})),t.push(new a.Paragraph({children:s,spacing:{after:120}}))}}}return 0===t.length&&t.push(new a.Paragraph({children:[new a.TextRun({text:e.replace(/<[^>]*>/g,"").trim()||"Empty document"})]})),t}(r),i=[new a.Paragraph({children:[new a.TextRun({text:t,bold:!0,size:28})],heading:a.HeadingLevel.TITLE,alignment:a.AlignmentType.CENTER,spacing:{after:400}}),...o],c=new a.Document({creator:n?.author||"AI Law Agent",title:t,description:`${s} generated by AI Law Agent`,sections:[{properties:{},children:i}]}),u=await a.Packer.toBuffer(c);return new Uint8Array(u)}a=(n.then?(await n)():n)[0],s()}catch(e){s(e)}})},1717:(e,t,r)=>{"use strict";r.d(t,{$w:()=>a});var s=r(2007);async function a(e){let{title:t,content:r,metadata:a}=e,n=await s.PDFDocument.create();n.setTitle(t),n.setAuthor(a?.author||"AI Law Agent"),n.setCreator(a?.creator||"AI Law Agent MVP"),n.setProducer(a?.producer||"AI Law Agent"),n.setCreationDate(a?.creationDate||new Date);let o=await n.embedFont(s.StandardFonts.TimesRoman),i=await n.embedFont(s.StandardFonts.TimesRomanBold),c=n.addPage(),{width:u,height:p}=c.getSize(),l=u-100,d=p-50,g=e=>{d-e<50&&(c=n.addPage(),d=p-50)};g(38),c.drawText(t,{x:50,y:d,size:18,font:i,color:(0,s.rgb)(0,0,0)}),d-=38;let f=r.replace(/<h[1-6][^>]*>/g,"\n\n").replace(/<\/h[1-6]>/g,"\n").replace(/<p[^>]*>/g,"\n").replace(/<\/p>/g,"\n").replace(/<br\s*\/?>/g,"\n").replace(/<strong[^>]*>|<\/strong>/g,"").replace(/<em[^>]*>|<\/em>/g,"").replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').trim().split(/\s+/),x="";for(let e of f){let t=x?`${x} ${e}`:e;o.widthOfTextAtSize(t,12)<=l?x=t:(x&&(g(14),c.drawText(x,{x:50,y:d,size:12,font:o,color:(0,s.rgb)(0,0,0)}),d-=14),x=e)}x&&(g(14),c.drawText(x,{x:50,y:d,size:12,font:o,color:(0,s.rgb)(0,0,0)}));let h=n.getPages();return h.forEach((e,t)=>{let{width:r}=e.getSize(),a=`Page ${t+1} of ${h.length}`,n=o.widthOfTextAtSize(a,10);e.drawText(a,{x:(r-n)/2,y:30,size:10,font:o,color:(0,s.rgb)(.5,.5,.5)})}),new Uint8Array(await n.save())}},2133:(e,t,r)=>{"use strict";r.d(t,{p:()=>o});var s=r(8775);let a="https://ycfwvgsumatjhycpyrqk.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljZnd2Z3N1bWF0amh5Y3B5cnFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyNTYxMzIsImV4cCI6MjA2NjgzMjEzMn0.jo33Y2UiF7CPr3lHte-KaHxcf12MXT3kd9QF2auZhzk";if(!a)throw Error("Missing env.NEXT_PUBLIC_SUPABASE_URL");if(!n)throw Error("Missing env.NEXT_PUBLIC_SUPABASE_ANON_KEY");(0,s.eI)(a,n);let o=(0,s.eI)(a,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[418,396],()=>r(6143));module.exports=s})();