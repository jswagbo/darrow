"use strict";(()=>{var e={};e.id=344,e.ids=[344],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2007:e=>{e.exports=require("pdf-lib")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},3808:e=>{e.exports=import("docx")},6143:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>u,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>x,staticGenerationAsyncStorage:()=>l});var s=r(8967),a=r(3589),n=r(8329),i=r(3250),c=e([i]);i=(c.then?(await c)():c)[0];let d=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/files/export/route",pathname:"/api/files/export",filename:"route",bundlePath:"app/api/files/export/route"},resolvedPagePath:"/Users/jeffnwagbo/AI Law Firm/constructa-starter-min-main/src/app/api/files/export/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:p,staticGenerationAsyncStorage:l,serverHooks:x}=d,f="/api/files/export/route";function u(){return(0,n.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:l})}o()}catch(e){o(e)}})},3250:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{GET:()=>d,POST:()=>u});var s=r(8148),a=r(2133),n=r(7765),i=r(1717),c=e([n]);async function u(e){try{let{documentId:t,format:r,regenerate:o=!1}=await e.json();if(!t)return s.NextResponse.json({success:!1,error:"Document ID is required",code:"INVALID_INPUT"},{status:400});if(!["docx","pdf"].includes(r))return s.NextResponse.json({success:!1,error:"Invalid export format. Must be docx or pdf",code:"INVALID_FORMAT"},{status:400});let c=e.headers.get("authorization");if(!c?.startsWith("Bearer "))return s.NextResponse.json({success:!1,error:"Authentication required",code:"UNAUTHORIZED"},{status:401});let u=c.split(" ")[1],{data:{user:d},error:p}=await a.p.auth.getUser(u);if(p||!d)return s.NextResponse.json({success:!1,error:"Invalid authentication token",code:"UNAUTHORIZED"},{status:401});let{data:l,error:x}=await a.p.from("docs").select("*").eq("id",t).eq("user_id",d.id).single();if(x||!l)return s.NextResponse.json({success:!1,error:"Document not found",code:"NOT_FOUND"},{status:404});let f=`${t}.${r}`,m=null;if(!o&&("docx"===r?l.docx_url:l.pdf_url)){let{data:e,error:t}=await a.p.storage.from("documents").list("",{search:f});if(!t&&e?.length>0){let{data:e,error:t}=await a.p.storage.from("documents").createSignedUrl(f,3600);if(!t&&e?.signedUrl)return s.NextResponse.json({success:!0,data:{downloadUrl:e.signedUrl,filename:`${l.title.replace(/\s+/g,"_")}.${r}`,expiresAt:new Date(Date.now()+36e5).toISOString()}})}}try{let e;e="docx"===r?await (0,n.RI)({title:l.title,content:l.content,docType:l.doc_type,metadata:{author:d.email||"AI Law Agent User",created:new Date(l.created_at)}}):await (0,i.$w)({title:l.title,content:l.content,metadata:{author:d.email||"AI Law Agent User",creator:"Darrow Legal Document Generation"}});let{data:o,error:c}=await a.p.storage.from("documents").upload(f,e,{contentType:"docx"===r?"application/vnd.openxmlformats-officedocument.wordprocessingml.document":"application/pdf",upsert:!0});if(c)return console.error("Storage upload error:",c),s.NextResponse.json({success:!1,error:"Failed to upload file to storage",code:"UPLOAD_ERROR"},{status:500});let{data:u,error:p}=await a.p.storage.from("documents").createSignedUrl(f,3600);if(p||!u?.signedUrl)return console.error("Signed URL error:",p),s.NextResponse.json({success:!1,error:"Failed to generate download URL",code:"URL_ERROR"},{status:500});return m=u.signedUrl,await a.p.from("docs").update({["docx"===r?"docx_url":"pdf_url"]:m,updated_at:new Date().toISOString()}).eq("id",t),s.NextResponse.json({success:!0,data:{downloadUrl:m,filename:`${l.title.replace(/\s+/g,"_")}.${r}`,expiresAt:new Date(Date.now()+36e5).toISOString()}})}catch(e){return console.error("File generation error:",e),s.NextResponse.json({success:!1,error:`Failed to generate ${r.toUpperCase()} file`,code:"GENERATION_ERROR"},{status:500})}}catch(e){return console.error("Export API error:",e),s.NextResponse.json({success:!1,error:"Internal server error",code:"INTERNAL_ERROR"},{status:500})}}async function d(){return s.NextResponse.json({success:!1,error:"Method not allowed",code:"METHOD_NOT_ALLOWED"},{status:405})}n=(c.then?(await c)():c)[0],o()}catch(e){o(e)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[418,396,751],()=>r(6143));module.exports=o})();