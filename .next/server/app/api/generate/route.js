"use strict";(()=>{var e={};e.id=290,e.ids=[290],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2007:e=>{e.exports=require("pdf-lib")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},2623:e=>{e.exports=require("worker_threads")},1568:e=>{e.exports=require("zlib")},3808:e=>{e.exports=import("docx")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},2477:e=>{e.exports=require("node:stream/web")},5561:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>d,requestAsyncStorage:()=>l,routeModule:()=>u,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p});var o=r(8967),n=r(3589),s=r(8329),i=r(2663),c=e([i]);i=(c.then?(await c)():c)[0];let u=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/generate/route",pathname:"/api/generate",filename:"route",bundlePath:"app/api/generate/route"},resolvedPagePath:"/Users/jeffnwagbo/AI Law Firm/constructa-starter-min-main/src/app/api/generate/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:l,staticGenerationAsyncStorage:p,serverHooks:g}=u,m="/api/generate/route";function d(){return(0,s.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}a()}catch(e){a(e)}})},2663:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{DELETE:()=>h,GET:()=>g,POST:()=>p,PUT:()=>m});var o=r(8148),n=r(2133),s=r(622),i=r(8233),c=r(7765),d=r(1717),u=r(5622),l=e([c]);async function p(e){try{let{title:t,docType:r,userInput:a,additionalContext:l}=await e.json();if(!t?.trim())return o.NextResponse.json({success:!1,error:"Document title is required",code:"INVALID_INPUT"},{status:400});if(!r||!Object.keys(u.qe).includes(r))return o.NextResponse.json({success:!1,error:"Invalid document type",code:"INVALID_DOC_TYPE"},{status:400});if(!a?.trim())return o.NextResponse.json({success:!1,error:"User input is required for document generation",code:"INVALID_INPUT"},{status:400});let p=e.headers.get("authorization");if(!p?.startsWith("Bearer "))return o.NextResponse.json({success:!1,error:"Authentication required",code:"UNAUTHORIZED"},{status:401});let g=p.split(" ")[1],{data:{user:m},error:h}=await n.p.auth.getUser(g);if(h||!m)return o.NextResponse.json({success:!1,error:"Invalid authentication token",code:"UNAUTHORIZED"},{status:401});let f=await (0,i.Nj)(m.id);if(!f){console.log("Primary rate limit check failed, trying fallback method");try{let e=await (0,i.h5)(m.id);f=e<3,console.log(`Fallback rate limit check: ${e}/3 documents today`)}catch(e){console.error("Fallback rate limit check failed:",e),f=!0}}if(!f){let e=await (0,i.h5)(m.id);return o.NextResponse.json({success:!1,...(0,i.N)(3-e)},{status:429})}let{data:x,error:w}=await n.p.from("docs").insert({user_id:m.id,title:t.trim(),doc_type:r,content:"",status:"generating"}).select().single();if(w||!x){if(console.error("Error creating document:",{error:w,userId:m.id,docType:r,title:t.trim(),timestamp:new Date().toISOString()}),w?.code==="42P01")return o.NextResponse.json({success:!1,error:"Database not initialized. Please contact support.",code:"DATABASE_SCHEMA_MISSING",details:"The docs table does not exist in the database"},{status:500});if(w?.code==="P0001"||w?.message?.includes("can_create_doc"))return o.NextResponse.json({success:!1,error:"Rate limit exceeded. You can create 3 documents per day.",code:"RATE_LIMIT_EXCEEDED"},{status:429});return o.NextResponse.json({success:!1,error:"Failed to create document record. Please try again.",code:"DATABASE_ERROR",details:w?.message},{status:500})}try{let e,i;let u=await (0,s.Wn)(r,a,l);if(!u.success||!u.content)return await n.p.from("docs").update({status:"error"}).eq("id",x.id),o.NextResponse.json({success:!1,error:u.error||"Failed to generate document content",code:"GENERATION_ERROR"},{status:500});let p=u.content;try{let a=await (0,c.RI)({title:t.trim(),content:p,docType:r,metadata:{author:m.email||"AI Law Agent User",created:new Date}}),o=`${x.id}.docx`,{data:s,error:i}=await n.p.storage.from("documents").upload(o,a,{contentType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",upsert:!0});if(!i&&s){let{data:t}=await n.p.storage.from("documents").createSignedUrl(o,3600);e=t?.signedUrl}}catch(e){console.error("Error generating DOCX:",e)}try{let e=await (0,d.$w)({title:t.trim(),content:p,metadata:{author:m.email||"AI Law Agent User",creator:"AI Law Agent MVP"}}),r=`${x.id}.pdf`,{data:a,error:o}=await n.p.storage.from("documents").upload(r,e,{contentType:"application/pdf",upsert:!0});if(!o&&a){let{data:e}=await n.p.storage.from("documents").createSignedUrl(r,3600);i=e?.signedUrl}}catch(e){console.error("Error generating PDF:",e)}let{error:g}=await n.p.from("docs").update({content:p,status:"completed",docx_url:e,pdf_url:i,updated_at:new Date().toISOString()}).eq("id",x.id);if(g)return console.error("Error updating document:",g),o.NextResponse.json({success:!1,error:"Failed to save generated document",code:"DATABASE_ERROR"},{status:500});return o.NextResponse.json({success:!0,data:{documentId:x.id,content:p,docxUrl:e,pdfUrl:i}})}catch(e){return console.error("Error in document generation process:",e),await n.p.from("docs").update({status:"error"}).eq("id",x.id),o.NextResponse.json({success:!1,error:"An error occurred during document generation",code:"GENERATION_ERROR"},{status:500})}}catch(e){return console.error("Unhandled error in generate API:",e),o.NextResponse.json({success:!1,error:"Internal server error",code:"INTERNAL_ERROR"},{status:500})}}async function g(){return o.NextResponse.json({success:!1,error:"Method not allowed",code:"METHOD_NOT_ALLOWED"},{status:405})}async function m(){return o.NextResponse.json({success:!1,error:"Method not allowed",code:"METHOD_NOT_ALLOWED"},{status:405})}async function h(){return o.NextResponse.json({success:!1,error:"Method not allowed",code:"METHOD_NOT_ALLOWED"},{status:405})}c=(l.then?(await l)():l)[0],a()}catch(e){a(e)}})},7765:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{RI:()=>s});var o=r(3808),n=e([o]);async function s(e){let{title:t,content:r,docType:a,metadata:n}=e,s=function(e){let t=[];for(let r of e.replace(/<\/p>/g,"</p>\n").replace(/<\/h[1-6]>/g,"</h>\n").split("\n").filter(e=>e.trim())){let e=r.replace(/<[^>]*>/g,"").trim();if(e){if(r.includes("<h1"))t.push(new o.Paragraph({text:e,heading:o.HeadingLevel.HEADING_1,spacing:{after:240}}));else if(r.includes("<h2"))t.push(new o.Paragraph({text:e,heading:o.HeadingLevel.HEADING_2,spacing:{after:200}}));else if(r.includes("<h3"))t.push(new o.Paragraph({text:e,heading:o.HeadingLevel.HEADING_3,spacing:{after:160}}));else{let a=[];r.includes("<strong>")||r.includes("<b>")?a.push(new o.TextRun({text:e,bold:!0})):r.includes("<em>")||r.includes("<i>")?a.push(new o.TextRun({text:e,italics:!0})):a.push(new o.TextRun({text:e})),t.push(new o.Paragraph({children:a,spacing:{after:120}}))}}}return 0===t.length&&t.push(new o.Paragraph({children:[new o.TextRun({text:e.replace(/<[^>]*>/g,"").trim()||"Empty document"})]})),t}(r),i=[new o.Paragraph({children:[new o.TextRun({text:t,bold:!0,size:28})],heading:o.HeadingLevel.TITLE,alignment:o.AlignmentType.CENTER,spacing:{after:400}}),...s],c=new o.Document({creator:n?.author||"AI Law Agent",title:t,description:`${a} generated by AI Law Agent`,sections:[{properties:{},children:i}]}),d=await o.Packer.toBuffer(c);return new Uint8Array(d)}o=(n.then?(await n)():n)[0],a()}catch(e){a(e)}})},1717:(e,t,r)=>{r.d(t,{$w:()=>o});var a=r(2007);async function o(e){let{title:t,content:r,metadata:o}=e,n=await a.PDFDocument.create();n.setTitle(t),n.setAuthor(o?.author||"AI Law Agent"),n.setCreator(o?.creator||"AI Law Agent MVP"),n.setProducer(o?.producer||"AI Law Agent"),n.setCreationDate(o?.creationDate||new Date);let s=await n.embedFont(a.StandardFonts.TimesRoman),i=await n.embedFont(a.StandardFonts.TimesRomanBold),c=n.addPage(),{width:d,height:u}=c.getSize(),l=d-100,p=u-50,g=e=>{p-e<50&&(c=n.addPage(),p=u-50)};g(38),c.drawText(t,{x:50,y:p,size:18,font:i,color:(0,a.rgb)(0,0,0)}),p-=38;let m=r.replace(/<h[1-6][^>]*>/g,"\n\n").replace(/<\/h[1-6]>/g,"\n").replace(/<p[^>]*>/g,"\n").replace(/<\/p>/g,"\n").replace(/<br\s*\/?>/g,"\n").replace(/<strong[^>]*>|<\/strong>/g,"").replace(/<em[^>]*>|<\/em>/g,"").replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').trim().split(/\s+/),h="";for(let e of m){let t=h?`${h} ${e}`:e;s.widthOfTextAtSize(t,12)<=l?h=t:(h&&(g(14),c.drawText(h,{x:50,y:p,size:12,font:s,color:(0,a.rgb)(0,0,0)}),p-=14),h=e)}h&&(g(14),c.drawText(h,{x:50,y:p,size:12,font:s,color:(0,a.rgb)(0,0,0)}));let f=n.getPages();return f.forEach((e,t)=>{let{width:r}=e.getSize(),o=`Page ${t+1} of ${f.length}`,n=s.widthOfTextAtSize(o,10);e.drawText(o,{x:(r-n)/2,y:30,size:10,font:s,color:(0,a.rgb)(.5,.5,.5)})}),new Uint8Array(await n.save())}},8233:(e,t,r)=>{r.d(t,{N:()=>s,Nj:()=>o,h5:()=>n});var a=r(2133);async function o(e){try{let{data:t,error:r}=await a.p.rpc("can_create_doc",{uid:e});if(r)return console.error("Error in server rate limit check:",{error:r,userId:e,timestamp:new Date().toISOString(),errorCode:r.code,errorMessage:r.message}),"PGRST202"===r.code&&console.error("Database function can_create_doc does not exist - schema not applied"),!1;return!0===t}catch(t){return console.error("Error in canCreateDocServer:",{error:t,userId:e,timestamp:new Date().toISOString()}),!1}}async function n(e){try{let t=new Date().toISOString().slice(0,10),{data:r,error:o}=await a.p.from("docs").select("id",{count:"exact",head:!0}).eq("user_id",e).eq("created_day",t);if(o)return console.error("Error getting document count:",o),0;return r?.length??0}catch(e){return console.error("Error in getTodayDocCountServer:",e),0}}function s(e=0){return{error:"Rate limit exceeded",message:`You have reached your daily limit of 3 documents. ${e} remaining today.`,code:"RATE_LIMIT_EXCEEDED",remainingDocs:e}}},5622:(e,t,r)=>{r.d(t,{cn:()=>n,qe:()=>s});var a=r(4286),o=r(8483);function n(...e){return(0,o.m6)((0,a.W)(e))}let s={delaware_charter:"Delaware Charter",safe_post:"YC SAFE (Post-Money)",offer_letter:"Offer Letter",rspa:"Restricted Stock Purchase Agreement",board_consent:"Board & Stockholder Consent"}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[418,396,588,609,91],()=>r(5561));module.exports=a})();