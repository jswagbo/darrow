"use strict";(()=>{var e={};e.id=290,e.ids=[290],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2007:e=>{e.exports=require("pdf-lib")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},2623:e=>{e.exports=require("worker_threads")},1568:e=>{e.exports=require("zlib")},3808:e=>{e.exports=import("docx")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},2477:e=>{e.exports=require("node:stream/web")},5561:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>u,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>l});var s=t(8967),a=t(3589),n=t(8329),c=t(2663),i=e([c]);c=(i.then?(await i)():i)[0];let d=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/generate/route",pathname:"/api/generate",filename:"route",bundlePath:"app/api/generate/route"},resolvedPagePath:"/Users/jeffnwagbo/AI Law Firm/constructa-starter-min-main/src/app/api/generate/route.ts",nextConfigOutput:"",userland:c}),{requestAsyncStorage:p,staticGenerationAsyncStorage:l,serverHooks:m}=d,g="/api/generate/route";function u(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:l})}o()}catch(e){o(e)}})},2663:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.r(r),t.d(r,{DELETE:()=>f,GET:()=>m,POST:()=>l,PUT:()=>g});var s=t(8148),a=t(2133),n=t(622),c=t(8233),i=t(7765),u=t(1717),d=t(5622),p=e([i]);async function l(e){try{let{title:r,docType:t,userInput:o,additionalContext:p}=await e.json();if(!r?.trim())return s.NextResponse.json({success:!1,error:"Document title is required",code:"INVALID_INPUT"},{status:400});if(!t||!Object.keys(d.qe).includes(t))return s.NextResponse.json({success:!1,error:"Invalid document type",code:"INVALID_DOC_TYPE"},{status:400});if(!o?.trim())return s.NextResponse.json({success:!1,error:"User input is required for document generation",code:"INVALID_INPUT"},{status:400});let l=e.headers.get("authorization");if(!l?.startsWith("Bearer "))return s.NextResponse.json({success:!1,error:"Authentication required",code:"UNAUTHORIZED"},{status:401});let m=l.split(" ")[1],{data:{user:g},error:f}=await a.p.auth.getUser(m);if(f||!g)return s.NextResponse.json({success:!1,error:"Invalid authentication token",code:"UNAUTHORIZED"},{status:401});let x=await (0,c.Nj)(g.id);if(!x){console.log("Primary rate limit check failed, trying fallback method");try{let e=await (0,c.h5)(g.id);x=e<3,console.log(`Fallback rate limit check: ${e}/3 documents today`)}catch(e){console.error("Fallback rate limit check failed:",e),x=!0}}if(!x){let e=await (0,c.h5)(g.id);return s.NextResponse.json({success:!1,...(0,c.N)(3-e)},{status:429})}let{data:h,error:E}=await a.p.from("docs").insert({user_id:g.id,title:r.trim(),doc_type:t,content:"",status:"generating"}).select().single();if(E||!h){if(console.error("Error creating document:",{error:E,userId:g.id,docType:t,title:r.trim(),timestamp:new Date().toISOString()}),E?.code==="42P01")return s.NextResponse.json({success:!1,error:"Database not initialized. Please contact support.",code:"DATABASE_SCHEMA_MISSING",details:"The docs table does not exist in the database"},{status:500});if(E?.code==="P0001"||E?.message?.includes("can_create_doc"))return s.NextResponse.json({success:!1,error:"Rate limit exceeded. You can create 3 documents per day.",code:"RATE_LIMIT_EXCEEDED"},{status:429});return s.NextResponse.json({success:!1,error:"Failed to create document record. Please try again.",code:"DATABASE_ERROR",details:E?.message},{status:500})}try{let e,c;let d=await (0,n.Wn)(t,o,p);if(!d.success||!d.content)return await a.p.from("docs").update({status:"error"}).eq("id",h.id),s.NextResponse.json({success:!1,error:d.error||"Failed to generate document content",code:"GENERATION_ERROR"},{status:500});let l=d.content;try{let o=await (0,i.RI)({title:r.trim(),content:l,docType:t,metadata:{author:g.email||"AI Law Agent User",created:new Date}}),s=`${h.id}.docx`,{data:n,error:c}=await a.p.storage.from("documents").upload(s,o,{contentType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",upsert:!0});if(!c&&n){let{data:r}=await a.p.storage.from("documents").createSignedUrl(s,3600);e=r?.signedUrl}}catch(e){console.error("Error generating DOCX:",e)}try{let e=await (0,u.$w)({title:r.trim(),content:l,metadata:{author:g.email||"AI Law Agent User",creator:"Darrow Legal Document Generation"}}),t=`${h.id}.pdf`,{data:o,error:s}=await a.p.storage.from("documents").upload(t,e,{contentType:"application/pdf",upsert:!0});if(!s&&o){let{data:e}=await a.p.storage.from("documents").createSignedUrl(t,3600);c=e?.signedUrl}}catch(e){console.error("Error generating PDF:",e)}let{error:m}=await a.p.from("docs").update({content:l,status:"completed",docx_url:e,pdf_url:c,updated_at:new Date().toISOString()}).eq("id",h.id);if(m)return console.error("Error updating document:",m),s.NextResponse.json({success:!1,error:"Failed to save generated document",code:"DATABASE_ERROR"},{status:500});return s.NextResponse.json({success:!0,data:{documentId:h.id,content:l,docxUrl:e,pdfUrl:c}})}catch(e){return console.error("Error in document generation process:",e),await a.p.from("docs").update({status:"error"}).eq("id",h.id),s.NextResponse.json({success:!1,error:"An error occurred during document generation",code:"GENERATION_ERROR"},{status:500})}}catch(e){return console.error("Unhandled error in generate API:",e),s.NextResponse.json({success:!1,error:"Internal server error",code:"INTERNAL_ERROR"},{status:500})}}async function m(){return s.NextResponse.json({success:!1,error:"Method not allowed",code:"METHOD_NOT_ALLOWED"},{status:405})}async function g(){return s.NextResponse.json({success:!1,error:"Method not allowed",code:"METHOD_NOT_ALLOWED"},{status:405})}async function f(){return s.NextResponse.json({success:!1,error:"Method not allowed",code:"METHOD_NOT_ALLOWED"},{status:405})}i=(p.then?(await p)():p)[0],o()}catch(e){o(e)}})},8233:(e,r,t)=>{t.d(r,{N:()=>n,Nj:()=>s,h5:()=>a});var o=t(2133);async function s(e){try{let{data:r,error:t}=await o.p.rpc("can_create_doc",{uid:e});if(t)return console.error("Error in server rate limit check:",{error:t,userId:e,timestamp:new Date().toISOString(),errorCode:t.code,errorMessage:t.message}),"PGRST202"===t.code&&console.error("Database function can_create_doc does not exist - schema not applied"),!1;return!0===r}catch(r){return console.error("Error in canCreateDocServer:",{error:r,userId:e,timestamp:new Date().toISOString()}),!1}}async function a(e){try{let r=new Date().toISOString().slice(0,10),{data:t,error:s}=await o.p.from("docs").select("id",{count:"exact",head:!0}).eq("user_id",e).eq("created_day",r);if(s)return console.error("Error getting document count:",s),0;return t?.length??0}catch(e){return console.error("Error in getTodayDocCountServer:",e),0}}function n(e=0){return{error:"Rate limit exceeded",message:`You have reached your daily limit of 3 documents. ${e} remaining today.`,code:"RATE_LIMIT_EXCEEDED",remainingDocs:e}}},5622:(e,r,t)=>{t.d(r,{cn:()=>a,qe:()=>n});var o=t(4286),s=t(8483);function a(...e){return(0,s.m6)((0,o.W)(e))}let n={delaware_charter:"Delaware Charter",safe_post:"YC SAFE (Post-Money)",offer_letter:"Offer Letter",rspa:"Restricted Stock Purchase Agreement",board_consent:"Board & Stockholder Consent"}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[418,396,588,609,751,622],()=>t(5561));module.exports=o})();